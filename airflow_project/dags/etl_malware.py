from airflow import DAG
from airflow.operators.python import PythonOperator
from datetime import datetime
import requests
import pandas as pd

RAW_PATH = "data/raw/openphish.txt"
TRANSFORMED_PATH = "data/processed/openphish_processed.csv"

def extract_data():
    url = "https://openphish.com/feed.txt"
    r = requests.get(url)
    r.raise_for_status()

    with open(RAW_PATH, "w") as file:
        file.write(r.text)

def transform_data():
    with open(RAW_PATH, "r") as file:
        url_data =file.read().splitlines()
    
    df = pd.DataFrame(url_data, columns=["Malicious URL"])
    df.to_csv(TRANSFORMED_PATH, index=False)


with DAG(
    dag_id ="etl_malware_dag", 
    start_date=datetime(2025,9,17), 
    schedule_interval="@daily",
    catchup=False) as dag:

    task_extract = PythonOperator(
        task_id="extract_data",
        python_callable=extract_data
    )

    task_transform = PythonOperator(
        task_id="transform_data",
        python_callable=transform_data
    )

    task_extract >> task_transform